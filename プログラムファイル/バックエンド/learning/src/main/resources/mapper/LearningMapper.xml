<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.udemy.hello.mapper.LearningMapper">
    
    <resultMap id="Learning" type="Learning">
        <id property="id" column="id" />
        <result property="title" column="title" />
        <result property="explanatory_text" column="explanatory_text" />
        <result property="understanding_level" column="understanding_level" />
        <result property="reference_url" column="reference_url" />
        <result property="created_at" column="created_at" />
        <result property="category_name" column="name" />
        <result property="github_path" column="github_path" />
        <result property="commit_sha" column="commit_sha" />
        <result property="delete_flg" column="delete_flg" />
    </resultMap>
    
    <resultMap id="Learning_i" type="Integer">
        <id property="id" column="id" />
        <result property="title" column="title" />
        <result property="explanatory_text" column="explanatory_text" />
        <result property="understanding_level" column="understanding_level" />
        <result property="reference_url" column="reference_url" />
        <result property="created_at" column="created_at" />
        <result property="category_id" column="category_id" />
    </resultMap>
    
    <resultMap id="categories" type="categories">
        <id property="id" column="id" />
        <result property="name" column="name" />
    </resultMap>
    
    <resultMap id="tags" type="tags">
        <id property="id" column="id" />
        <result property="name" column="name" />
    </resultMap>
    
    <resultMap id="tag" type="Integer">
        <id property="id" column="id" />
        <result property="name" column="name" />
    </resultMap>
    
    <resultMap id="learning_tag" type="learning_tag">
        <id property="id" column="id" />
        <result property="learning_id" column="learning_id" />
        <result property="tag_id" column="tag_id" />
    </resultMap>

    <select id="findAll" resultMap="Learning">
        SELECT * 
        FROM learnings
        INNER JOIN categories ON categories.id = learnings.category_id
        WHERE learnings.delete_flg = 0
        ORDER BY learnings.id ASC
    </select>
    
    <select id="category_list" resultMap="categories">
        SELECT * 
        FROM categories
        ORDER BY id ASC
    </select>
    
    <select id="tag_list" resultMap="tags">
        SELECT * 
        FROM tags
        ORDER BY id ASC
    </select>
    
    <select id="learning_tag" resultMap="learning_tag">
        SELECT * 
        FROM learning_tags
        ORDER BY id ASC
    </select>
    
    <insert id="learning_insert">
    	INSERT INTO learnings
        (title,explanatory_text,understanding_level,reference_url,created_at,category_id,github_path,commit_sha)
        VALUES 
        (#{title},#{explanatory_text},#{understanding_level},#{reference_url},#{created_at},#{category_id},#{github_path},#{commit_sha});
    </insert>
    
    <select id="learning_one_select" resultMap="Learning_i">
        SELECT id
        FROM learnings
        ORDER BY id DESC
        LIMIT 1;
    </select>
    
    <insert id="learning_tag_insert">
        INSERT INTO learning_tags
        (learning_id,tag_id)
        VALUES 
        (#{learning_id},#{tag_id});
    </insert>
    
    <insert id="tags_insert">
        INSERT INTO tags
        (name)
        VALUES 
        (#{name});
    </insert>
    
    <select id="tags_search" resultMap="tag">
        SELECT id
        FROM tags
        WHERE name = #{name}
        ORDER BY id;
    </select>
    
    <delete id="tags_delete">
        DELETE
        FROM learning_tags
        WHERE learning_id = #{learning_id};
    </delete>
    
    <update id="learning_update">
    	UPDATE learnings
        SET title = #{title},
         explanatory_text = #{explanatory_text},
         understanding_level = #{understanding_level},
         reference_url = #{reference_url},
         created_at = #{created_at},
         category_id = #{category_id},
         github_path = #{github_path},
         commit_sha = #{commit_sha}
        WHERE id = #{id};
    </update>
    
    <update id="learning_delete">
	    UPDATE learnings
	    SET delete_flg = 1
	    WHERE id = #{id}
    </update>
    
    <insert id="category_insert">
        INSERT INTO categories
        (name)
        VALUES 
        (#{name});
    </insert>
    
</mapper>